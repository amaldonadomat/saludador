name: Pre-Release (Manual)

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Description of this pre-release'
        required: false
        default: 'Manual pre-release for testing'

jobs:
  pre-release:
    name: Build and Publish Pre-Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para setuptools-scm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        id: build_info
        run: |
          # setuptools-scm genera versi√≥n .post<distance> autom√°ticamente
          python -m build
          echo "‚úÖ Package built"
          ls -lh dist/

          # Extraer la versi√≥n real del nombre del archivo .whl construido
          BUILT_VERSION=$(ls dist/*.whl | head -n 1 | grep -oP 'alpyro_saludador-\K[^-]+' || echo "unknown")
          echo "built_version=$BUILT_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Built version: $BUILT_VERSION"

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          twine upload --repository testpypi dist/*
          echo "‚úÖ Pre-release package published to TestPyPI"
          echo ""
          echo "Version: ${{ steps.build_info.outputs.built_version }}"
          echo ""
          echo "Install with:"
          echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple alpyro-saludador==${{ steps.build_info.outputs.built_version }}"

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Pre-Release Published

          **Version:** \`${{ steps.build_info.outputs.built_version }}\`

          **Description:** ${{ github.event.inputs.description }}

          ### Installation
          \`\`\`bash
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple alpyro-saludador==${{ steps.build_info.outputs.built_version }}
          \`\`\`

          ### Testing
          \`\`\`bash
          # Crear entorno virtual
          python -m venv test-env
          source test-env/bin/activate

          # Instalar pre-release
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple alpyro-saludador==${{ steps.build_info.outputs.built_version }}

          # Probar
          saludar
          saludar "Test User" --idioma en
          \`\`\`
          EOF
