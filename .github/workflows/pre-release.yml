name: Pre-Release (Manual)

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Description of this pre-release'
        required: false
        default: 'Manual pre-release for testing'

jobs:
  pre-release:
    name: Build and Publish Pre-Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para setuptools-scm

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Get version info
        id: version_info
        run: |
          # setuptools-scm genera autom√°ticamente la versi√≥n .post (post-release)
          pip install setuptools-scm
          VERSION=$(python -c "from setuptools_scm import get_version; print(get_version())")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Pre-release version: $VERSION"

          # Verificar que sea una versi√≥n post-release
          if [[ "$VERSION" =~ \.post[0-9]+ ]]; then
            echo "‚úÖ Post-release version detected"
          elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ö†Ô∏è  Warning: This is a tagged release version: $VERSION"
            echo "Pre-release workflow should be run from commits without tags"
          else
            echo "‚ÑπÔ∏è  Version format: $VERSION"
          fi

      - name: Build package
        run: |
          # setuptools-scm genera versi√≥n .dev<distance>+g<hash> autom√°ticamente
          python -m build
          echo "‚úÖ Package built"
          ls -lh dist/

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          twine upload --repository testpypi dist/*
          echo "‚úÖ Pre-release package published to TestPyPI"
          echo ""
          echo "Version: ${{ steps.version_info.outputs.version }}"
          echo ""
          echo "Install with:"
          echo "pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple alpyro-saludador==${{ steps.version_info.outputs.version }}"

      - name: Create summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Pre-Release Published

          **Version:** \`${{ steps.version_info.outputs.version }}\`

          **Description:** ${{ github.event.inputs.description }}

          ### Installation
          \`\`\`bash
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple alpyro-saludador==${{ steps.version_info.outputs.version }}
          \`\`\`

          ### Testing
          \`\`\`bash
          # Crear entorno virtual
          python -m venv test-env
          source test-env/bin/activate

          # Instalar pre-release
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple alpyro-saludador==${{ steps.version_info.outputs.version }}

          # Probar
          saludar
          saludar "Test User" --idioma en
          \`\`\`
          EOF
